---
- name: Install prerequisite packages
  become: true
  ansible.builtin.yum:
    name:
      - acl
      - sudo
      - wget
      - perl
    state: present

- name: Install python3 packages
  become: true
  ansible.builtin.yum:
    name:
      - python3-psycopg2
      - python3-cryptography
    state: present

- name: Fixup some locale issues
  become: true
  ansible.builtin.lineinfile:
    dest: /etc/locale.conf
    line: "{{ item }}"
    state: present
    create: true
    mode: '0644'
  loop:
    - LANG=en_us.UTF-8
    - LANGUAGE=en_us.UTF-8

- name: Enable PostgreSQL module
  become: true
  ansible.builtin.dnf:
    name: "@postgresql:{{ postgres_version }}"
    state: present
  when:
    - ansible_os_family == 'RedHat'
    - ansible_distribution_major_version | int == 8

# - name: Enable PostgreSQL module
#   become: true
#   ansible.builtin.copy:
#     dest: /etc/dnf/modules.d/postgresql.module
#     owner: root
#     group: root
#     mode: '0644'
#     content: |
#       [postgresql]
#       name=postgresql
#       stream=15
#       profiles=server
#       state=enabled
#   when:
#     - ansible_os_family == 'RedHat'
#     - ansible_distribution_major_version | int == 8

- name: Install PostgreSQL packages
  become: true
  ansible.builtin.yum:
    name:
      - postgresql-server
      - postgresql-contrib
    state: present
  register: install_postgresql
  until: install_postgresql is success
  retries: 3
  delay: 3
